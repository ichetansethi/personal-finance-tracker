<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard | Finance Tracker</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <nav class="navbar">
    <div class="nav-container">
      <a href="index.html" class="nav-brand">üí∞ Finance Tracker</a>
      <ul class="nav-links">
        <li><a href="index.html" class="active">Dashboard</a></li>
        <li><a href="transactions.html">Transactions</a></li>
        <li><a href="expenses.html">Expenses</a></li>
        <li><a href="incomes.html">Incomes</a></li>
        <li><a href="categories.html">Categories</a></li>
        <li><a href="summary.html">Analytics</a></li>
        <li><span id="userDisplay">User</span></li>
        <li><button class="btn-logout" onclick="logout()">Logout</button></li>
      </ul>
    </div>
  </nav>

  <div class="container">
    <div class="page-header">
      <h1 class="page-title">üìä Personal Finance Dashboard</h1>
      <p class="page-subtitle">Track your income, expenses, and financial health at a glance</p>
    </div>

    <!-- Top stats -->
    <div class="stats-grid">
      <div class="stat-card income">
        <div class="stat-label">
          <span class="stat-icon">üí∞</span>
          Total Income
        </div>
        <div class="stat-value" id="income">‚Çπ0.00</div>
      </div>
      <div class="stat-card expense">
        <div class="stat-label">
          <span class="stat-icon">üí∏</span>
          Total Expense
        </div>
        <div class="stat-value" id="expense">‚Çπ0.00</div>
      </div>
      <div class="stat-card balance">
        <div class="stat-label">
          <span class="stat-icon">üíµ</span>
          Net Balance
        </div>
        <div class="stat-value" id="netBalance">‚Çπ0.00</div>
      </div>
    </div>

    <!-- Chart + Alerts -->
    <div class="card">
      <div class="card-header">
        <h2 class="card-title">
          <span>üìà</span>
          Category-wise Expense
        </h2>
      </div>
      <div class="chart-container">
        <canvas id="categoryChart"></canvas>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <h2 class="card-title">
          <span>üîî</span>
          Budget Alerts
        </h2>
      </div>
      <div id="alertList" class="mt-1">
        <div class="loading">Loading alerts...</div>
      </div>
    </div>
  </div>

  <script src="config.js"></script>
  <script src="app.js"></script>
  <script>
  async function loadSummary() {
    const now = new Date();
    const month = now.getMonth() + 1;
    const year = now.getFullYear();

    if (!isAuthenticated()) {
      redirectToLogin();
      return;
    }

    const apiBaseUrl = window.API_BASE_URL || 'http://localhost:8085/api';
    const response = await fetch(
      `${apiBaseUrl}/summary/monthly?month=${month}&year=${year}`,
      {
        headers: getAuthHeaders()
      }
    );

    const data = await response.json();

    // Set income/expense/net with proper formatting
    document.getElementById('income').textContent = '‚Çπ' + (data.totalIncome || 0).toFixed(2);
    document.getElementById('expense').textContent = '‚Çπ' + (data.totalExpense || 0).toFixed(2);
    const net = (data.totalIncome || 0) - (data.totalExpense || 0);
    document.getElementById('netBalance').textContent = '‚Çπ' + net.toFixed(2);

    // Draw chart
    const ctx = document.getElementById('categoryChart').getContext('2d');
    new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: Object.keys(data.categorySummary),
        datasets: [{
          data: Object.values(data.categorySummary),
          backgroundColor: [
            '#667eea', '#22c55e', '#f97316', '#0ea5e9',
            '#ec4899', '#a855f7', '#facc15', '#fb7185'
          ],
          borderWidth: 3,
          borderColor: '#ffffff',
          hoverOffset: 10
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              padding: 15,
              font: {
                size: 13,
                weight: '500'
              },
              usePointStyle: true,
              pointStyle: 'circle'
            }
          },
          tooltip: {
            backgroundColor: 'rgba(0, 0, 0, 0.8)',
            padding: 12,
            titleFont: {
              size: 14,
              weight: 'bold'
            },
            bodyFont: {
              size: 13
            },
            callbacks: {
              label: function(context) {
                const label = context.label || '';
                const value = context.parsed || 0;
                return label + ': ‚Çπ' + value.toFixed(2);
              }
            }
          }
        }
      }
    });

    // Alerts
    const alertContainer = document.getElementById('alertList');
    alertContainer.innerHTML = '';

    if (!data.budgetAlerts || data.budgetAlerts.length === 0) {
      alertContainer.innerHTML = '<div class="empty-state">No budget alerts ‚Äì you are on track üéâ</div>';
      return;
    }

    data.budgetAlerts.forEach(alert => {
      const wrapper = document.createElement('div');
      wrapper.className = `alert-item ${alert.exceeded ? 'alert-exceeded' : 'alert-ok'}`;

      wrapper.innerHTML = `
        <div class="alert-content">
          <div class="alert-category">${alert.category}</div>
          <div class="alert-details">
            Spent: ‚Çπ${alert.spent.toFixed(2)} /
            Budget: ${alert.budget ? '‚Çπ' + alert.budget.toFixed(2) : 'Not set'}
          </div>
        </div>
        <span class="badge ${alert.exceeded ? 'badge-danger' : 'badge-success'}">
          ${alert.exceeded ? '‚ö†Ô∏è Exceeded' : '‚úÖ OK'}
        </span>
      `;

      alertContainer.appendChild(wrapper);
    });
  }

  document.addEventListener('DOMContentLoaded', () => {
    initUser();
    loadSummary();
  });
  </script>

</body>
</html>